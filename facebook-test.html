<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Login Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        button {
            background-color: #1877F2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background-color: #166FE5;
        }
        .card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .page-item {
            border: 1px solid #eee;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .hidden {
            display: none;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Facebook Login Test</h1>
    
    <div class="card">
        <h2>Step 1: Initialize Facebook SDK</h2>
        <p>This test page uses a development App ID. For production, you'll need to create your own Facebook App.</p>
        <button id="initSDK">Initialize Facebook SDK</button>
        <div id="sdkStatus" class="hidden"></div>
    </div>

    <div class="card">
        <h2>Step 2: Login with Facebook</h2>
        <p>Click the button below to login with Facebook. This will request permissions to manage your Facebook Pages.</p>
        <button id="loginBtn" disabled>Login with Facebook</button>
        <div id="loginStatus" class="hidden"></div>
    </div>

    <div class="card">
        <h2>Step 3: Get Your Facebook Pages</h2>
        <p>After logging in, click this button to retrieve your Facebook Pages.</p>
        <button id="getPagesBtn" disabled>Get My Pages</button>
        <div id="pagesContainer" class="hidden">
            <h3>Your Pages:</h3>
            <div id="pagesList"></div>
        </div>
    </div>

    <div class="card">
        <h2>Step 4: Test Post to Page</h2>
        <p>Select a page above first, then fill out this form to test posting.</p>
        <div id="postForm" class="hidden">
            <div>
                <label for="message">Message:</label><br>
                <textarea id="message" rows="4" style="width: 100%">This is a test post from Car Customer Connect!</textarea>
            </div>
            <div style="margin-top: 10px;">
                <label for="imageUrl">Image URL (optional):</label><br>
                <input type="text" id="imageUrl" style="width: 100%" placeholder="https://example.com/image.jpg">
            </div>
            <button id="postBtn" style="margin-top: 10px;">Post to Selected Page</button>
            <div id="postStatus" class="hidden"></div>
        </div>
    </div>

    <div class="card">
        <h2>Debug Information</h2>
        <pre id="debugInfo">No data yet</pre>
    </div>

    <script>
        // Variables to store state
        let accessToken = null;
        let selectedPage = null;
        let pages = [];

        // Function to update debug info
        function updateDebugInfo(data) {
            document.getElementById('debugInfo').textContent = JSON.stringify(data, null, 2);
        }

        // Function to show status message
        function showStatus(elementId, message, isSuccess) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.classList.remove('hidden', 'success', 'error');
            statusElement.classList.add(isSuccess ? 'success' : 'error');
        }

        // Initialize Facebook SDK
        document.getElementById('initSDK').addEventListener('click', function() {
            // Load the Facebook SDK asynchronously
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));

            // Initialize the Facebook SDK once it's loaded
            window.fbAsyncInit = function() {
                FB.init({
                    appId      : '1234567890123456', // This is a placeholder App ID
                    cookie     : true,
                    xfbml      : true,
                    version    : 'v18.0'
                });
                
                showStatus('sdkStatus', 'Facebook SDK initialized successfully!', true);
                document.getElementById('loginBtn').disabled = false;
                
                // Check login status
                FB.getLoginStatus(function(response) {
                    updateDebugInfo(response);
                    if (response.status === 'connected') {
                        accessToken = response.authResponse.accessToken;
                        showStatus('loginStatus', 'Already logged in!', true);
                        document.getElementById('getPagesBtn').disabled = false;
                    }
                });
            };

            this.disabled = true;
        });

        // Login with Facebook
        document.getElementById('loginBtn').addEventListener('click', function() {
            FB.login(function(response) {
                updateDebugInfo(response);
                
                if (response.authResponse) {
                    accessToken = response.authResponse.accessToken;
                    showStatus('loginStatus', 'Successfully logged in!', true);
                    document.getElementById('getPagesBtn').disabled = false;
                } else {
                    showStatus('loginStatus', 'Login cancelled or failed.', false);
                }
            }, {scope: 'pages_show_list,pages_manage_posts,pages_read_engagement'});
        });

        // Get Facebook Pages
        document.getElementById('getPagesBtn').addEventListener('click', function() {
            FB.api('/me/accounts', function(response) {
                updateDebugInfo(response);
                
                if (response.error) {
                    showStatus('pagesContainer', `Error: ${response.error.message}`, false);
                    return;
                }
                
                pages = response.data;
                const pagesContainer = document.getElementById('pagesContainer');
                const pagesList = document.getElementById('pagesList');
                pagesList.innerHTML = '';
                
                if (pages.length === 0) {
                    pagesList.innerHTML = '<p>No pages found. You need to have admin access to at least one Facebook Page.</p>';
                } else {
                    pages.forEach(page => {
                        const pageItem = document.createElement('div');
                        pageItem.className = 'page-item';
                        
                        const pageInfo = document.createElement('div');
                        pageInfo.innerHTML = `<strong>${page.name}</strong>`;
                        
                        const selectBtn = document.createElement('button');
                        selectBtn.textContent = 'Select';
                        selectBtn.addEventListener('click', function() {
                            selectedPage = page;
                            document.querySelectorAll('.page-item').forEach(item => {
                                item.style.backgroundColor = '';
                            });
                            pageItem.style.backgroundColor = '#e6f7ff';
                            document.getElementById('postForm').classList.remove('hidden');
                            showStatus('pagesContainer', `Selected page: ${page.name}`, true);
                        });
                        
                        pageItem.appendChild(pageInfo);
                        pageItem.appendChild(selectBtn);
                        pagesList.appendChild(pageItem);
                    });
                }
                
                pagesContainer.classList.remove('hidden');
            });
        });

        // Post to Page
        document.getElementById('postBtn').addEventListener('click', function() {
            if (!selectedPage) {
                showStatus('postStatus', 'Please select a page first!', false);
                return;
            }
            
            const message = document.getElementById('message').value;
            const imageUrl = document.getElementById('imageUrl').value;
            
            if (!message && !imageUrl) {
                showStatus('postStatus', 'Please enter a message or provide an image URL!', false);
                return;
            }
            
            const pageAccessToken = selectedPage.access_token;
            const pageId = selectedPage.id;
            
            // If we have an image URL, post as a photo
            if (imageUrl) {
                FB.api(
                    `/${pageId}/photos`,
                    'POST',
                    {
                        message: message,
                        url: imageUrl,
                        access_token: pageAccessToken
                    },
                    function(response) {
                        updateDebugInfo(response);
                        
                        if (response.error) {
                            showStatus('postStatus', `Error: ${response.error.message}`, false);
                        } else {
                            showStatus('postStatus', 'Posted successfully! Photo ID: ' + response.id, true);
                        }
                    }
                );
            } else {
                // Otherwise post as a status update
                FB.api(
                    `/${pageId}/feed`,
                    'POST',
                    {
                        message: message,
                        access_token: pageAccessToken
                    },
                    function(response) {
                        updateDebugInfo(response);
                        
                        if (response.error) {
                            showStatus('postStatus', `Error: ${response.error.message}`, false);
                        } else {
                            showStatus('postStatus', 'Posted successfully! Post ID: ' + response.id, true);
                        }
                    }
                );
            }
        });
    </script>
</body>
</html>
